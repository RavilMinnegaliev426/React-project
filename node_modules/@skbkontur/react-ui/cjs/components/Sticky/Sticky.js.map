{"version":3,"sources":["Sticky.tsx"],"names":["MAX_REFLOW_RETRIES","Sticky","state","fixed","deltaHeight","stopped","relativeTop","wrapper","inner","layoutSubscription","remove","reflowCounter","refWrapper","ref","refInner","reflow","document","documentElement","Error","windowHeight","window","innerHeight","clientHeight","getBoundingClientRect","top","bottom","left","width","height","props","offset","getStop","side","prevFixed","prevHeight","setState","stop","stopRect","outerHeight","componentDidMount","LayoutEvents","addListener","componentWillUnmount","componentDidUpdate","prevProps","prevState","emit","render","children","innerStyle","jsStyles","container","React","Component","__KONTUR_REACT_UI__","propTypes","PropTypes","oneOfType","node","func","number","oneOf","isRequired","defaultProps"],"mappings":"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","sourcesContent":["import React from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport shallowEqual from 'shallowequal';\r\nimport cn from 'classnames';\r\n\r\nimport * as LayoutEvents from '../../lib/LayoutEvents';\r\nimport { Nullable } from '../../typings/utility-types';\r\nimport { isFunction } from '../../lib/utils';\r\nimport { ZIndex } from '../../internal/ZIndex';\r\n\r\nimport { jsStyles } from './Sticky.styles';\r\n\r\nconst MAX_REFLOW_RETRIES = 5;\r\n\r\nexport interface StickyProps {\r\n  side: 'top' | 'bottom';\r\n  /**\r\n   * Отступ в пикселях от края экрана, на сколько сдвигается элемент в залипшем состоянии\r\n   * @default 0\r\n   */\r\n  offset: number;\r\n  getStop?: () => Nullable<HTMLElement>;\r\n  children?: React.ReactNode | ((fixed: boolean) => React.ReactNode);\r\n}\r\n\r\nexport interface StickyState {\r\n  fixed: boolean;\r\n  deltaHeight: number;\r\n  height?: number;\r\n  width?: number;\r\n  left?: number;\r\n  stopped: boolean;\r\n  relativeTop: number;\r\n}\r\n\r\nexport class Sticky extends React.Component<StickyProps, StickyState> {\r\n  public static __KONTUR_REACT_UI__ = 'Sticky';\r\n\r\n  public static propTypes = {\r\n    children: PropTypes.oneOfType([PropTypes.node, PropTypes.func]),\r\n\r\n    /**\r\n     * Функция, которая возвращает DOM-элемент, который нельзя пересекать.\r\n     */\r\n    getStop: PropTypes.func,\r\n\r\n    /**\r\n     * Отступ от границы в пикселях\r\n     */\r\n    offset: PropTypes.number,\r\n\r\n    side: PropTypes.oneOf(['top', 'bottom']).isRequired,\r\n  };\r\n\r\n  public static defaultProps = { offset: 0 };\r\n\r\n  public state: StickyState = {\r\n    fixed: false,\r\n    deltaHeight: 0,\r\n    stopped: false,\r\n    relativeTop: 0,\r\n  };\r\n\r\n  private wrapper: Nullable<HTMLElement>;\r\n  private inner: Nullable<HTMLElement>;\r\n  private layoutSubscription: { remove: Nullable<() => void> } = { remove: null };\r\n  private reflowCounter = 0;\r\n\r\n  public componentDidMount() {\r\n    this.reflow();\r\n\r\n    this.layoutSubscription = LayoutEvents.addListener(this.reflow);\r\n  }\r\n\r\n  public componentWillUnmount() {\r\n    if (this.layoutSubscription.remove) {\r\n      this.layoutSubscription.remove();\r\n    }\r\n  }\r\n\r\n  public componentDidUpdate(prevProps: StickyProps, prevState: StickyState) {\r\n    if (!shallowEqual(prevProps, this.props) || !shallowEqual(prevState, this.state)) {\r\n      if (this.reflowCounter < MAX_REFLOW_RETRIES) {\r\n        LayoutEvents.emit();\r\n        this.reflowCounter += 1;\r\n        return;\r\n      }\r\n    }\r\n    this.reflowCounter = 0;\r\n  }\r\n\r\n  public render() {\r\n    let { children } = this.props;\r\n    const { side, offset } = this.props;\r\n    const { fixed, stopped, relativeTop, deltaHeight, width, height, left } = this.state;\r\n    const innerStyle: React.CSSProperties = {};\r\n\r\n    if (fixed) {\r\n      if (stopped) {\r\n        innerStyle.top = relativeTop;\r\n        innerStyle[side === 'top' ? 'marginTop' : 'marginBottom'] = deltaHeight;\r\n      } else {\r\n        innerStyle.width = width;\r\n        innerStyle[side] = offset;\r\n        innerStyle.left = left;\r\n      }\r\n    }\r\n\r\n    if (isFunction(children)) {\r\n      children = children(fixed);\r\n    }\r\n\r\n    return (\r\n      <div ref={this.refWrapper}>\r\n        <ZIndex\r\n          priority=\"Sticky\"\r\n          applyZIndex={fixed}\r\n          className={cn(jsStyles.inner(), {\r\n            [jsStyles.fixed()]: fixed && !stopped,\r\n            [jsStyles.stopped()]: stopped,\r\n          })}\r\n          style={innerStyle}\r\n          wrapperRef={this.refInner}\r\n        >\r\n          <div className={jsStyles.container()}>{children}</div>\r\n        </ZIndex>\r\n        {fixed && !stopped ? <div style={{ width, height }} /> : null}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private refWrapper = (ref: Nullable<HTMLElement>) => (this.wrapper = ref);\r\n\r\n  private refInner = (ref: Nullable<HTMLElement>) => (this.inner = ref);\r\n\r\n  private reflow = () => {\r\n    const { documentElement } = document;\r\n\r\n    if (!documentElement) {\r\n      throw Error('There is no \"documentElement\" in document');\r\n    }\r\n\r\n    const windowHeight = window.innerHeight || documentElement.clientHeight;\r\n    if (!this.wrapper || !this.inner) {\r\n      return;\r\n    }\r\n    const { top, bottom, left } = this.wrapper.getBoundingClientRect();\r\n    const { width, height } = this.inner.getBoundingClientRect();\r\n    const { offset, getStop, side } = this.props;\r\n    const { fixed: prevFixed, height: prevHeight = height } = this.state;\r\n    const fixed = side === 'top' ? top < offset : bottom > windowHeight - offset;\r\n\r\n    this.setState({ fixed, left });\r\n\r\n    if (fixed && !prevFixed) {\r\n      this.setState({ width, height });\r\n    }\r\n\r\n    if (fixed) {\r\n      const stop = getStop && getStop();\r\n      if (stop) {\r\n        const deltaHeight = prevHeight - height;\r\n        const stopRect = stop.getBoundingClientRect();\r\n        const outerHeight = height + offset;\r\n        let stopped = false;\r\n        let relativeTop = 0;\r\n\r\n        if (side === 'top') {\r\n          stopped = stopRect.top - outerHeight < 0;\r\n          relativeTop = stopRect.top - height - top;\r\n        } else {\r\n          stopped = stopRect.bottom + outerHeight > windowHeight;\r\n          relativeTop = stopRect.bottom - top;\r\n        }\r\n\r\n        this.setState({ relativeTop, deltaHeight, stopped });\r\n      }\r\n    }\r\n  };\r\n}\r\n"]}