{"version":3,"sources":["FiasAPI.ts"],"names":["FiasAPI","baseUrl","version","fetchFn","fetch","regionsPromise","verify","address","query","directParent","search","send","createQuery","method","headers","Accept","body","JSON","stringify","convertForVerification","then","success","data","error","verifiedAddress","isValid","invalidLevel","FiasAPIResultFactory","toLowerCase","fail","message","fiasId","searchText","field","parentFiasId","limit","fullAddress","prefix","actual","emptyResult","status","resolveFiasId","text","trimSearchText","resolveAddress","FiasFields","region","searchRegions","house","searchHouse","stead","searchStead","room","searchRoom","searchAddressObject","levels","Promise","resolve","searchCountry","path","params","resultPromise","result","ok","json","reject","Error","FiasLogger","warnings","fetchError","noBaseUrl","catch","log","level","map","isStartsWithSearchText","str","includes","filter","name","code","searchStopWords","Object","keys","abbreviations","reduce","words","abbr","split","abbrWords","word","key","prototype","hasOwnProperty","call","param","undefined","Array","isArray","push","encodeURIComponent","join","replace","slice"],"mappings":"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","sourcesContent":["import {\r\n  FiasAddressObject,\r\n  FiasAddressResponse,\r\n  FiasAPIProvider,\r\n  FiasAPIResult,\r\n  FiasFetchFn,\r\n  FiasFetchResponse,\r\n  FiasCountry,\r\n  FiasId,\r\n  FiasFields,\r\n  FiasHouse,\r\n  FiasRoom,\r\n  FiasSearchOptions,\r\n  FiasSearchResponse,\r\n  FiasStead,\r\n  FiasVerifyResponse,\r\n} from '../types';\r\nimport { abbreviations } from '../constants/abbreviations';\r\nimport { FiasLogger } from '../logger/FiasLogger';\r\nimport { fetch } from '../../../lib/net/fetch';\r\nimport { FiasAddress } from '../models/FiasAddress';\r\n\r\nimport { FiasAPIResultFactory } from './FiasAPIResultFactory';\r\n\r\ninterface FiasSearchQuery {\r\n  [key: string]: string | number | boolean | FiasId | FiasFields[] | undefined;\r\n  address?: string;\r\n  prefix?: string;\r\n  parentFiasId?: FiasId;\r\n  levels?: FiasFields[];\r\n  fullAddress?: boolean;\r\n  directParent?: boolean;\r\n  limit?: number;\r\n  actual?: boolean;\r\n  version?: string;\r\n}\r\n\r\nexport class FiasAPI implements FiasAPIProvider {\r\n  private static searchStopWords: { [key: string]: boolean } = Object.keys(abbreviations).reduce((words, abbr) => {\r\n    return {\r\n      ...words,\r\n      ...abbreviations[abbr].split(' ').reduce((abbrWords, word) => ({ ...abbrWords, [word.toLowerCase()]: true }), {}),\r\n    };\r\n  }, {});\r\n\r\n  private static createQuery = (query: FiasSearchQuery): string => {\r\n    const params = [];\r\n    for (const key in query) {\r\n      if (Object.prototype.hasOwnProperty.call(query, key)) {\r\n        const param = query[key];\r\n        if (param !== undefined) {\r\n          if (key === 'levels' && Array.isArray(param)) {\r\n            for (const level of param) {\r\n              params.push(`level[]=${encodeURIComponent(level)}`);\r\n            }\r\n          } else {\r\n            params.push(`${key}=${encodeURIComponent(`${param}`)}`);\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return params.join('&');\r\n  };\r\n\r\n  private static trimSearchText = (searchText: string): string => {\r\n    return searchText\r\n      .toLowerCase()\r\n      .replace(/югра/g, '')\r\n      .replace(/(строение|сооружение|литера)\\s[а-я\\w]+/g, '')\r\n      .replace(/\\s-\\s/g, ' ')\r\n      .replace(/[,]/g, '')\r\n      .replace(/\\s[\\s]*/g, ' ')\r\n      .split(' ')\r\n      .filter(word => !FiasAPI.searchStopWords[word])\r\n      .slice(0, 6)\r\n      .join(' ');\r\n  };\r\n\r\n  private regionsPromise: Promise<FiasAPIResult<FiasSearchResponse>> | null = null;\r\n\r\n  constructor(private baseUrl: string = '', private version?: string, private fetchFn: FiasFetchFn = fetch) {}\r\n\r\n  public verify = (address: FiasAddress): Promise<FiasAPIResult<FiasVerifyResponse>> => {\r\n    const query = {\r\n      directParent: true,\r\n      search: false,\r\n    };\r\n    return this.send<FiasVerifyResponse[]>(`verify?${FiasAPI.createQuery(query)}`, {\r\n      method: 'POST',\r\n      headers: {\r\n        Accept: 'application/json',\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify([address.convertForVerification()]),\r\n    }).then(({ success, data, error }: FiasAPIResult<FiasVerifyResponse[]>) => {\r\n      if (success && data) {\r\n        const { address: verifiedAddress = {}, isValid = false, invalidLevel }: FiasVerifyResponse = data[0] || {};\r\n        return FiasAPIResultFactory.success<FiasVerifyResponse>({\r\n          address: verifiedAddress,\r\n          isValid,\r\n          ...(invalidLevel ? { invalidLevel: invalidLevel.toLowerCase() as FiasFields } : {}),\r\n        });\r\n      } else {\r\n        return FiasAPIResultFactory.fail<FiasVerifyResponse>(error && error.message);\r\n      }\r\n    });\r\n  };\r\n\r\n  public search = ({\r\n    fiasId,\r\n    searchText,\r\n    field,\r\n    parentFiasId,\r\n    limit,\r\n    fullAddress,\r\n    directParent,\r\n  }: FiasSearchOptions): Promise<FiasAPIResult<FiasSearchResponse>> => {\r\n    const query: FiasSearchQuery = {\r\n      prefix: searchText,\r\n      actual: true,\r\n      parentFiasId,\r\n      limit,\r\n      fullAddress,\r\n      directParent,\r\n      version: this.version,\r\n    };\r\n    const emptyResult = {\r\n      success: true,\r\n      status: 200,\r\n      data: [],\r\n    };\r\n\r\n    if (fiasId) {\r\n      return this.resolveFiasId(fiasId);\r\n    }\r\n\r\n    if (searchText) {\r\n      if (!field) {\r\n        const text = FiasAPI.trimSearchText(searchText);\r\n        if (text) {\r\n          return this.resolveAddress(text, limit);\r\n        }\r\n      } else {\r\n        switch (field) {\r\n          case FiasFields.region:\r\n            return this.searchRegions(searchText);\r\n          case FiasFields.house:\r\n            return this.searchHouse(query);\r\n          case FiasFields.stead:\r\n            return this.searchStead(query);\r\n          case FiasFields.room:\r\n            return this.searchRoom(query);\r\n          default:\r\n            return this.searchAddressObject({ ...query, levels: [field] });\r\n        }\r\n      }\r\n    }\r\n\r\n    return Promise.resolve(emptyResult);\r\n  };\r\n\r\n  public searchCountry = (query: { prefix: string; limit?: number }): Promise<FiasAPIResult<FiasCountry[]>> => {\r\n    return this.send(`countries?${FiasAPI.createQuery(query)}`);\r\n  };\r\n\r\n  private send = <Data>(path: string, params = {}): Promise<FiasAPIResult<Data>> => {\r\n    const resultPromise = this.baseUrl\r\n      ? this.fetchFn(`${this.baseUrl}${path}`, {\r\n          method: 'GET',\r\n          ...params,\r\n        }).then((result: FiasFetchResponse) => {\r\n          return result.ok\r\n            ? result.json().then((data: Data) => FiasAPIResultFactory.success<Data>(data))\r\n            : Promise.reject(new Error(FiasLogger.warnings.fetchError));\r\n        })\r\n      : Promise.reject(new Error(FiasLogger.warnings.noBaseUrl));\r\n\r\n    return resultPromise.catch(({ message }) => {\r\n      FiasLogger.log(message);\r\n      return FiasAPIResultFactory.fail<Data>(message);\r\n    });\r\n  };\r\n\r\n  private resolveFiasId = (fiasId: FiasId): Promise<FiasAPIResult<FiasSearchResponse>> => {\r\n    return this.send<FiasAddressResponse>(`addresses/structural/${fiasId}`).then(result => {\r\n      const { success, data, error } = result;\r\n      if (success && data) {\r\n        return FiasAPIResultFactory.success<FiasSearchResponse>([data]);\r\n      } else {\r\n        return FiasAPIResultFactory.fail<FiasSearchResponse>(error && error.message);\r\n      }\r\n    });\r\n  };\r\n\r\n  private searchAddressObject = (query: FiasSearchQuery): Promise<FiasAPIResult<FiasSearchResponse>> => {\r\n    return this.send<FiasSearchResponse>(`addresses?${FiasAPI.createQuery(query)}`);\r\n  };\r\n\r\n  private resolveAddress = (\r\n    address: string,\r\n    limit?: number,\r\n    level: FiasFields = FiasFields.house,\r\n  ): Promise<FiasAPIResult<FiasSearchResponse>> => {\r\n    return this.send<FiasSearchResponse>(\r\n      `addresses/resolve?${FiasAPI.createQuery({\r\n        address,\r\n        limit,\r\n        level,\r\n      })}`,\r\n    );\r\n  };\r\n\r\n  private searchStead = (query: FiasSearchQuery): Promise<FiasAPIResult<FiasSearchResponse>> => {\r\n    return this.send<FiasStead[]>(`steads?${FiasAPI.createQuery(query)}`).then(result => {\r\n      const { success, data, error } = result;\r\n      if (success && data) {\r\n        return FiasAPIResultFactory.success<FiasSearchResponse>(\r\n          data.map((stead: FiasStead) => {\r\n            return {\r\n              stead,\r\n            };\r\n          }),\r\n        );\r\n      } else {\r\n        return FiasAPIResultFactory.fail<FiasSearchResponse>(error && error.message);\r\n      }\r\n    });\r\n  };\r\n\r\n  private searchHouse = (query: FiasSearchQuery): Promise<FiasAPIResult<FiasSearchResponse>> => {\r\n    return this.send<FiasHouse[]>(`houses?${FiasAPI.createQuery(query)}`).then(result => {\r\n      const { success, data, error } = result;\r\n      if (success && data) {\r\n        return FiasAPIResultFactory.success<FiasSearchResponse>(\r\n          data.map((house: FiasHouse) => {\r\n            return {\r\n              house,\r\n            };\r\n          }),\r\n        );\r\n      } else {\r\n        return FiasAPIResultFactory.fail<FiasSearchResponse>(error && error.message);\r\n      }\r\n    });\r\n  };\r\n\r\n  private searchRoom = (query: FiasSearchQuery): Promise<FiasAPIResult<FiasSearchResponse>> => {\r\n    return this.send<FiasRoom[]>(`rooms?${FiasAPI.createQuery(query)}`).then(result => {\r\n      const { success, data, error } = result;\r\n      if (success && data) {\r\n        return FiasAPIResultFactory.success<FiasSearchResponse>(\r\n          data.map((room: FiasRoom) => {\r\n            return {\r\n              room,\r\n            };\r\n          }),\r\n        );\r\n      } else {\r\n        return FiasAPIResultFactory.fail<FiasSearchResponse>(error && error.message);\r\n      }\r\n    });\r\n  };\r\n\r\n  private searchRegions = (searchText: string): Promise<FiasAPIResult<FiasSearchResponse>> => {\r\n    if (!this.regionsPromise) {\r\n      this.regionsPromise = this.send<FiasSearchResponse>('addresses/regions');\r\n    }\r\n    if (!searchText) {\r\n      return this.regionsPromise;\r\n    }\r\n\r\n    const isStartsWithSearchText = (str: string) => {\r\n      return str && str.toLowerCase().includes(searchText.toLowerCase());\r\n    };\r\n\r\n    return this.regionsPromise.then(result => {\r\n      const { success, data } = result;\r\n      if (success && data) {\r\n        return FiasAPIResultFactory.success<FiasSearchResponse>(\r\n          data.filter((address: FiasAddressResponse) => {\r\n            const { name, code = '' } = address.region as FiasAddressObject;\r\n            return isStartsWithSearchText(name) || isStartsWithSearchText(code);\r\n          }),\r\n        );\r\n      }\r\n      return result;\r\n    });\r\n  };\r\n}\r\n"]}