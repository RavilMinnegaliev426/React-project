{"version":3,"sources":["Sticky.tsx"],"names":["React","PropTypes","shallowEqual","cn","LayoutEvents","isFunction","ZIndex","jsStyles","MAX_REFLOW_RETRIES","Sticky","state","fixed","deltaHeight","stopped","relativeTop","wrapper","inner","layoutSubscription","remove","reflowCounter","refWrapper","ref","refInner","reflow","document","documentElement","Error","windowHeight","window","innerHeight","clientHeight","getBoundingClientRect","top","bottom","left","width","height","props","offset","getStop","side","prevFixed","prevHeight","setState","stop","stopRect","outerHeight","componentDidMount","addListener","componentWillUnmount","componentDidUpdate","prevProps","prevState","emit","render","children","innerStyle","container","Component","__KONTUR_REACT_UI__","propTypes","oneOfType","node","func","number","oneOf","isRequired","defaultProps"],"mappings":"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","sourcesContent":["import React from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport shallowEqual from 'shallowequal';\r\nimport cn from 'classnames';\r\n\r\nimport * as LayoutEvents from '../../lib/LayoutEvents';\r\nimport { Nullable } from '../../typings/utility-types';\r\nimport { isFunction } from '../../lib/utils';\r\nimport { ZIndex } from '../../internal/ZIndex';\r\n\r\nimport { jsStyles } from './Sticky.styles';\r\n\r\nconst MAX_REFLOW_RETRIES = 5;\r\n\r\nexport interface StickyProps {\r\n  side: 'top' | 'bottom';\r\n  /**\r\n   * Отступ в пикселях от края экрана, на сколько сдвигается элемент в залипшем состоянии\r\n   * @default 0\r\n   */\r\n  offset: number;\r\n  getStop?: () => Nullable<HTMLElement>;\r\n  children?: React.ReactNode | ((fixed: boolean) => React.ReactNode);\r\n}\r\n\r\nexport interface StickyState {\r\n  fixed: boolean;\r\n  deltaHeight: number;\r\n  height?: number;\r\n  width?: number;\r\n  left?: number;\r\n  stopped: boolean;\r\n  relativeTop: number;\r\n}\r\n\r\nexport class Sticky extends React.Component<StickyProps, StickyState> {\r\n  public static __KONTUR_REACT_UI__ = 'Sticky';\r\n\r\n  public static propTypes = {\r\n    children: PropTypes.oneOfType([PropTypes.node, PropTypes.func]),\r\n\r\n    /**\r\n     * Функция, которая возвращает DOM-элемент, который нельзя пересекать.\r\n     */\r\n    getStop: PropTypes.func,\r\n\r\n    /**\r\n     * Отступ от границы в пикселях\r\n     */\r\n    offset: PropTypes.number,\r\n\r\n    side: PropTypes.oneOf(['top', 'bottom']).isRequired,\r\n  };\r\n\r\n  public static defaultProps = { offset: 0 };\r\n\r\n  public state: StickyState = {\r\n    fixed: false,\r\n    deltaHeight: 0,\r\n    stopped: false,\r\n    relativeTop: 0,\r\n  };\r\n\r\n  private wrapper: Nullable<HTMLElement>;\r\n  private inner: Nullable<HTMLElement>;\r\n  private layoutSubscription: { remove: Nullable<() => void> } = { remove: null };\r\n  private reflowCounter = 0;\r\n\r\n  public componentDidMount() {\r\n    this.reflow();\r\n\r\n    this.layoutSubscription = LayoutEvents.addListener(this.reflow);\r\n  }\r\n\r\n  public componentWillUnmount() {\r\n    if (this.layoutSubscription.remove) {\r\n      this.layoutSubscription.remove();\r\n    }\r\n  }\r\n\r\n  public componentDidUpdate(prevProps: StickyProps, prevState: StickyState) {\r\n    if (!shallowEqual(prevProps, this.props) || !shallowEqual(prevState, this.state)) {\r\n      if (this.reflowCounter < MAX_REFLOW_RETRIES) {\r\n        LayoutEvents.emit();\r\n        this.reflowCounter += 1;\r\n        return;\r\n      }\r\n    }\r\n    this.reflowCounter = 0;\r\n  }\r\n\r\n  public render() {\r\n    let { children } = this.props;\r\n    const { side, offset } = this.props;\r\n    const { fixed, stopped, relativeTop, deltaHeight, width, height, left } = this.state;\r\n    const innerStyle: React.CSSProperties = {};\r\n\r\n    if (fixed) {\r\n      if (stopped) {\r\n        innerStyle.top = relativeTop;\r\n        innerStyle[side === 'top' ? 'marginTop' : 'marginBottom'] = deltaHeight;\r\n      } else {\r\n        innerStyle.width = width;\r\n        innerStyle[side] = offset;\r\n        innerStyle.left = left;\r\n      }\r\n    }\r\n\r\n    if (isFunction(children)) {\r\n      children = children(fixed);\r\n    }\r\n\r\n    return (\r\n      <div ref={this.refWrapper}>\r\n        <ZIndex\r\n          priority=\"Sticky\"\r\n          applyZIndex={fixed}\r\n          className={cn(jsStyles.inner(), {\r\n            [jsStyles.fixed()]: fixed && !stopped,\r\n            [jsStyles.stopped()]: stopped,\r\n          })}\r\n          style={innerStyle}\r\n          wrapperRef={this.refInner}\r\n        >\r\n          <div className={jsStyles.container()}>{children}</div>\r\n        </ZIndex>\r\n        {fixed && !stopped ? <div style={{ width, height }} /> : null}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private refWrapper = (ref: Nullable<HTMLElement>) => (this.wrapper = ref);\r\n\r\n  private refInner = (ref: Nullable<HTMLElement>) => (this.inner = ref);\r\n\r\n  private reflow = () => {\r\n    const { documentElement } = document;\r\n\r\n    if (!documentElement) {\r\n      throw Error('There is no \"documentElement\" in document');\r\n    }\r\n\r\n    const windowHeight = window.innerHeight || documentElement.clientHeight;\r\n    if (!this.wrapper || !this.inner) {\r\n      return;\r\n    }\r\n    const { top, bottom, left } = this.wrapper.getBoundingClientRect();\r\n    const { width, height } = this.inner.getBoundingClientRect();\r\n    const { offset, getStop, side } = this.props;\r\n    const { fixed: prevFixed, height: prevHeight = height } = this.state;\r\n    const fixed = side === 'top' ? top < offset : bottom > windowHeight - offset;\r\n\r\n    this.setState({ fixed, left });\r\n\r\n    if (fixed && !prevFixed) {\r\n      this.setState({ width, height });\r\n    }\r\n\r\n    if (fixed) {\r\n      const stop = getStop && getStop();\r\n      if (stop) {\r\n        const deltaHeight = prevHeight - height;\r\n        const stopRect = stop.getBoundingClientRect();\r\n        const outerHeight = height + offset;\r\n        let stopped = false;\r\n        let relativeTop = 0;\r\n\r\n        if (side === 'top') {\r\n          stopped = stopRect.top - outerHeight < 0;\r\n          relativeTop = stopRect.top - height - top;\r\n        } else {\r\n          stopped = stopRect.bottom + outerHeight > windowHeight;\r\n          relativeTop = stopRect.bottom - top;\r\n        }\r\n\r\n        this.setState({ relativeTop, deltaHeight, stopped });\r\n      }\r\n    }\r\n  };\r\n}\r\n"]}