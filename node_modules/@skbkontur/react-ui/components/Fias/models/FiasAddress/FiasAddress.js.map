{"version":3,"sources":["FiasAddress.ts"],"names":["isEqual","FiasFields","FiasExtraFields","FiasAddressElement","FiasData","FiasAddress","fields","additionalFields","errors","country","foreignAddress","getAddressErrors","getText","minField","skipTypes","connector","isEmpty","getElementText","element","getParentFields","MAIN_FIELDS","map","field","filter","Boolean","join","getFullText","withPostalCode","substrings","push","postalCode","fullName","isForeign","isAllowedToFill","region","city","settlement","house","hasCityOrSettlement","isFederalCity","street","stead","room","isAllowedToSearchFullAddress","FULL_ADDRESS_SEARCH_FIELDS","includes","isAllowedToSearchThroughChildrenOfDirectParent","fieldsSettings","parentField","isFieldVisible","NOT_ONLY_DIRECT_PARENT_SEARCH_FIELDS","hasOnlyIndirectParent","parents","length","directParent","pop","some","parent","getClosestParentFiasId","slice","reverse","fiasId","getFiasId","getParent","f","closest","verifyConsistency","verifiedFields","data","expectedParentFiasId","parentFiasId","address","fieldsToResponse","isValid","invalidLevel","getFiasPostalCode","getAddressValue","Object","keys","reduce","value","name","fiasData","getValue","addressString","addressErrors","convertForVerification","VERIFIABLE_FIELDS","verifiableData","getDiffFields","filterVisibleFields","isEqualTo","hasError","prototype","hasOwnProperty","call","getError","IS_RUSSIA","postalcode","rusFormat","foreignFormat","test","fiasPostalCode","district","intracityarea","planningstructure","ADDITIONAL_FIELDS","ALL_FIELDS","shortName","code","responseToFields","response","forEach","fiasObject","createFromResponse","createFromAddressValue","addressValue","addressField","createFromAddress","options","validate","locale","error","addressNotVerified","isPostalCodeValid","postalcodeNotValid","isPostalCodeAltered","postalcodeNotFound","verify","addressResponse","verifiedAddress","invalidField","removeFiasData","getChildFields","filteredFields","settings","visible","index","indexOf","addressFields","removeData","getAddress","api","searchOptions","searchText","limit","search","success"],"mappings":"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","sourcesContent":["import isEqual from 'lodash.isequal';\r\n\r\nimport { FiasLocale } from '../locale';\r\nimport {\r\n  FiasAddressErrors,\r\n  FiasAddressFields,\r\n  FiasAdditionalFields,\r\n  FiasVerifyResponse,\r\n  FiasAddressResponse,\r\n  FiasAddressValue,\r\n  FiasId,\r\n  FiasValue,\r\n  FiasFields,\r\n  FiasExtraFields,\r\n  FiasFieldsSettings,\r\n  FiasCountry,\r\n  FiasSearchOptions,\r\n  FiasAPIProvider,\r\n} from '../types';\r\n\r\nimport { FiasAddressElement } from './FiasAddressElement';\r\nimport { FiasData } from './FiasData';\r\n\r\nexport interface FiasAddressOptions {\r\n  fields?: FiasAddressFields;\r\n  additionalFields?: FiasAdditionalFields;\r\n  errors?: FiasAddressErrors;\r\n  country?: FiasCountry;\r\n  foreignAddress?: string;\r\n}\r\n\r\nexport class FiasAddress {\r\n  public static MAIN_FIELDS = [\r\n    FiasFields.region,\r\n    FiasFields.district,\r\n    FiasFields.city,\r\n    FiasFields.intracityarea,\r\n    FiasFields.settlement,\r\n    FiasFields.planningstructure,\r\n    FiasFields.street,\r\n    FiasFields.stead,\r\n    FiasFields.house,\r\n    FiasFields.room,\r\n  ];\r\n\r\n  public static ADDITIONAL_FIELDS = [FiasExtraFields.postalcode];\r\n\r\n  public static ALL_FIELDS = [...FiasAddress.MAIN_FIELDS, ...FiasAddress.ADDITIONAL_FIELDS];\r\n\r\n  public static VERIFIABLE_FIELDS = [\r\n    FiasFields.region,\r\n    FiasFields.district,\r\n    FiasFields.city,\r\n    FiasFields.intracityarea,\r\n    FiasFields.settlement,\r\n    FiasFields.planningstructure,\r\n    FiasFields.street,\r\n  ];\r\n\r\n  public static FULL_ADDRESS_SEARCH_FIELDS = [\r\n    FiasFields.district,\r\n    FiasFields.city,\r\n    FiasFields.intracityarea,\r\n    FiasFields.settlement,\r\n    FiasFields.planningstructure,\r\n    FiasFields.street,\r\n  ];\r\n\r\n  public static NOT_ONLY_DIRECT_PARENT_SEARCH_FIELDS = [\r\n    FiasFields.district,\r\n    FiasFields.city,\r\n    FiasFields.intracityarea,\r\n    FiasFields.settlement,\r\n    FiasFields.planningstructure,\r\n    FiasFields.street,\r\n  ];\r\n\r\n  public static IS_RUSSIA = (country: FiasCountry): boolean => {\r\n    return isEqual(country, {\r\n      shortName: 'Россия',\r\n      fullName: 'Российская Федерация',\r\n      code: '643',\r\n    });\r\n  };\r\n\r\n  public static responseToFields = (response: FiasAddressResponse): FiasAddressFields => {\r\n    const fields: FiasAddressFields = {};\r\n    if (response) {\r\n      FiasAddress.MAIN_FIELDS.forEach(field => {\r\n        const fiasObject = response[field];\r\n        if (fiasObject) {\r\n          const data: FiasData = new FiasData(fiasObject);\r\n          fields[field] = new FiasAddressElement(field, data.name, data);\r\n        }\r\n      });\r\n    }\r\n    return fields;\r\n  };\r\n\r\n  public static fieldsToResponse = (fields: FiasAddressFields): FiasAddressResponse => {\r\n    const response: FiasAddressResponse = {};\r\n    if (fields) {\r\n      FiasAddress.MAIN_FIELDS.forEach(field => {\r\n        const element = fields[field];\r\n        if (element && element.fiasData) {\r\n          response[field] = element.fiasData;\r\n        }\r\n      });\r\n    }\r\n    return response;\r\n  };\r\n\r\n  public static createFromResponse = (\r\n    response: FiasAddressResponse,\r\n    additionalFields?: FiasAdditionalFields,\r\n    country?: FiasCountry,\r\n  ) => {\r\n    return new FiasAddress({ fields: FiasAddress.responseToFields(response), additionalFields, country });\r\n  };\r\n\r\n  public static createFromAddressValue = (\r\n    addressValue: FiasAddressValue,\r\n    additionalFields?: FiasAdditionalFields,\r\n    country?: FiasCountry,\r\n  ) => {\r\n    const fields: FiasAddressFields = {};\r\n    if (addressValue) {\r\n      FiasAddress.MAIN_FIELDS.forEach(field => {\r\n        const addressField = addressValue[field];\r\n        if (addressField) {\r\n          const { name, data } = addressField;\r\n          fields[field] = new FiasAddressElement(field, name, data && new FiasData(data));\r\n        }\r\n      });\r\n    }\r\n    return new FiasAddress({ fields, additionalFields, country });\r\n  };\r\n\r\n  public static createFromAddress = (address: FiasAddress, options: FiasAddressOptions) => {\r\n    const { fields, additionalFields, errors, country, foreignAddress } = address;\r\n    return new FiasAddress({\r\n      fields,\r\n      additionalFields,\r\n      errors,\r\n      country,\r\n      foreignAddress,\r\n      ...options,\r\n    });\r\n  };\r\n\r\n  public static validate = (address: FiasAddress, locale: FiasLocale): FiasAddress => {\r\n    const { fields } = address;\r\n    const errors: FiasAddressErrors = {};\r\n\r\n    for (const field of FiasAddress.MAIN_FIELDS) {\r\n      const element = fields[field];\r\n      let error = '';\r\n\r\n      if (element) {\r\n        if (!element.data) {\r\n          error = locale.addressNotVerified;\r\n        }\r\n\r\n        if (!address.isAllowedToFill(field)) {\r\n          error = locale[`${field}FillBefore` as keyof FiasLocale];\r\n        }\r\n\r\n        if (error) {\r\n          errors[field] = error;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (Object.keys(errors).length === 0) {\r\n      if (address.postalCode && !address.isPostalCodeValid) {\r\n        errors[FiasExtraFields.postalcode] = locale.postalcodeNotValid;\r\n      } else if (address.isPostalCodeAltered) {\r\n        errors[FiasExtraFields.postalcode] = locale.postalcodeNotFound;\r\n      }\r\n    }\r\n\r\n    return FiasAddress.createFromAddress(address, { errors });\r\n  };\r\n\r\n  public static verify = (address: FiasAddress, response: FiasVerifyResponse): FiasAddress => {\r\n    if (address.isEmpty) {\r\n      return address;\r\n    }\r\n\r\n    const { address: addressResponse, invalidLevel } = response;\r\n    const verifiedAddress = FiasAddress.createFromAddress(address, {\r\n      fields: {\r\n        ...address.fields,\r\n        ...FiasAddress.responseToFields(addressResponse),\r\n      },\r\n    });\r\n\r\n    const invalidField = invalidLevel || verifiedAddress.verifyConsistency().invalidLevel;\r\n\r\n    if (invalidField) {\r\n      return FiasAddress.removeFiasData(verifiedAddress, [invalidField, ...FiasAddress.getChildFields(invalidField)]);\r\n    }\r\n\r\n    return verifiedAddress;\r\n  };\r\n\r\n  // TODO: Hide invisible fields without removing them.\r\n  // (removing can break the verification)\r\n  public static filterVisibleFields = (\r\n    fields: { [key in FiasFields]?: any },\r\n    fieldsSettings: FiasFieldsSettings,\r\n  ): { [key in FiasFields]?: any } => {\r\n    const filteredFields: { [key in FiasFields]?: any } = {};\r\n    let field: FiasFields;\r\n    for (field in fields) {\r\n      if (FiasAddress.isFieldVisible(field, fieldsSettings)) {\r\n        filteredFields[field] = fields[field];\r\n      }\r\n    }\r\n    return filteredFields;\r\n  };\r\n\r\n  public static isFieldVisible = (field: FiasFields | FiasExtraFields, fieldsSettings: FiasFieldsSettings): boolean => {\r\n    const settings = fieldsSettings[field];\r\n    return Boolean(settings && settings.visible);\r\n  };\r\n\r\n  public static getParentFields = (field: FiasFields) => {\r\n    const index = FiasAddress.MAIN_FIELDS.indexOf(field);\r\n    return index > -1 ? FiasAddress.MAIN_FIELDS.slice(0, index) : [];\r\n  };\r\n\r\n  public static getChildFields = (field: FiasFields) => {\r\n    const index = FiasAddress.MAIN_FIELDS.indexOf(field);\r\n    return index > -1 ? FiasAddress.MAIN_FIELDS.slice(index + 1) : [];\r\n  };\r\n\r\n  public static removeFiasData = (\r\n    address: FiasAddress,\r\n    fields: FiasFields[] = FiasAddress.MAIN_FIELDS,\r\n  ): FiasAddress => {\r\n    const addressFields = { ...address.fields };\r\n    for (const field of fields) {\r\n      const element = addressFields[field];\r\n      if (element) {\r\n        element.removeData();\r\n      }\r\n    }\r\n    return FiasAddress.createFromAddress(address, { fields: addressFields });\r\n  };\r\n\r\n  public static getAddress = async (\r\n    api: FiasAPIProvider,\r\n    value?: Partial<FiasValue>,\r\n    fieldsSettings?: FiasFieldsSettings,\r\n  ) => {\r\n    if (!value) {\r\n      return new FiasAddress();\r\n    }\r\n\r\n    const { address, addressString, fiasId, postalCode, country, foreignAddress } = value;\r\n    const additionalFields: FiasAdditionalFields = {};\r\n    let searchOptions: FiasSearchOptions = {};\r\n\r\n    if (postalCode) {\r\n      additionalFields[FiasExtraFields.postalcode] = postalCode;\r\n    }\r\n\r\n    if (country && !FiasAddress.IS_RUSSIA(country)) {\r\n      return new FiasAddress({\r\n        country,\r\n        foreignAddress,\r\n        additionalFields: { [FiasExtraFields.postalcode]: postalCode },\r\n      });\r\n    }\r\n\r\n    if (address) {\r\n      const addressValue = fieldsSettings ? FiasAddress.filterVisibleFields(address, fieldsSettings) : address;\r\n      return FiasAddress.createFromAddressValue(addressValue, additionalFields, country);\r\n    }\r\n\r\n    if (fiasId) {\r\n      searchOptions = {\r\n        fiasId,\r\n      };\r\n    }\r\n\r\n    if (addressString) {\r\n      searchOptions = {\r\n        searchText: addressString,\r\n        limit: 1,\r\n      };\r\n    }\r\n\r\n    if (api) {\r\n      const { success, data } = await api.search(searchOptions);\r\n      if (success && data && data.length) {\r\n        const addressResponse = fieldsSettings ? FiasAddress.filterVisibleFields(data[0], fieldsSettings) : data[0];\r\n        return FiasAddress.createFromResponse(addressResponse, additionalFields, country);\r\n      }\r\n    }\r\n\r\n    return new FiasAddress({ country });\r\n  };\r\n\r\n  public fields: FiasAddressFields;\r\n  public additionalFields: FiasAdditionalFields;\r\n  public errors: FiasAddressErrors;\r\n  public country: FiasCountry | undefined;\r\n  public foreignAddress: string;\r\n\r\n  constructor({ fields, additionalFields, errors, country, foreignAddress }: FiasAddressOptions = {}) {\r\n    this.fields = fields || {};\r\n    this.additionalFields = additionalFields || {};\r\n    this.errors = errors || {};\r\n    this.country = country;\r\n    this.foreignAddress = foreignAddress || '';\r\n  }\r\n\r\n  public get isForeign(): boolean {\r\n    return Boolean(this.country && !FiasAddress.IS_RUSSIA(this.country));\r\n  }\r\n\r\n  public get isEmpty(): boolean {\r\n    return !FiasAddress.MAIN_FIELDS.some(field => Object.prototype.hasOwnProperty.call(this.fields, field));\r\n  }\r\n\r\n  public get hasErrors(): boolean {\r\n    return Object.keys(this.errors).length > 0;\r\n  }\r\n\r\n  public get postalCode(): string {\r\n    const value = this.additionalFields[FiasExtraFields.postalcode];\r\n    return typeof value === 'string' ? value : this.getFiasPostalCode();\r\n  }\r\n\r\n  public get isPostalCodeValid(): boolean {\r\n    const rusFormat = /^[\\d]{6}$/;\r\n    const foreignFormat = /^[\\w.\\-\\s]*$/;\r\n    return (!this.country || this.isForeign ? foreignFormat : rusFormat).test(this.postalCode);\r\n  }\r\n\r\n  public get isPostalCodeAltered(): boolean {\r\n    const fiasPostalCode = this.getFiasPostalCode();\r\n    return Boolean(fiasPostalCode) && this.postalCode !== fiasPostalCode;\r\n  }\r\n\r\n  public hasError(field: FiasFields | FiasExtraFields): boolean {\r\n    return Object.prototype.hasOwnProperty.call(this.errors, field);\r\n  }\r\n\r\n  public getError(field: FiasFields | FiasExtraFields): string | undefined {\r\n    return this.errors[field];\r\n  }\r\n\r\n  public getAddressErrors = () => {\r\n    return {\r\n      ...this.errors,\r\n    };\r\n  };\r\n\r\n  public getText = (minField?: FiasFields, skipTypes = false, connector = ', '): string => {\r\n    if (this.isEmpty) {\r\n      return '';\r\n    }\r\n    const getElementText = (element?: FiasAddressElement): string => {\r\n      return element ? element.getText(skipTypes) : '';\r\n    };\r\n    const fields = minField ? FiasAddress.getParentFields(minField) : FiasAddress.MAIN_FIELDS;\r\n    return fields\r\n      .map(field => getElementText(this.fields[field]))\r\n      .filter(Boolean)\r\n      .join(connector);\r\n  };\r\n\r\n  public getFullText = (withPostalCode = false) => {\r\n    const substrings: string[] = [];\r\n\r\n    if (withPostalCode) {\r\n      substrings.push(this.postalCode);\r\n    }\r\n\r\n    if (this.country) {\r\n      substrings.push(this.country.fullName);\r\n    }\r\n\r\n    substrings.push(this.isForeign ? this.foreignAddress : this.getText());\r\n\r\n    return substrings.filter(Boolean).join(', ');\r\n  };\r\n\r\n  public isAllowedToFill = (field: FiasFields): boolean => {\r\n    const { region, city, settlement, house } = this.fields;\r\n    const hasCityOrSettlement = city || settlement || (region && region.isFederalCity);\r\n    if (\r\n      (!hasCityOrSettlement &&\r\n        (field === FiasFields.street || field === FiasFields.stead || field === FiasFields.house)) ||\r\n      (!house && field === FiasFields.room)\r\n    ) {\r\n      return false;\r\n    }\r\n    return true;\r\n  };\r\n\r\n  public isAllowedToSearchFullAddress = (field: FiasFields): boolean => {\r\n    return FiasAddress.FULL_ADDRESS_SEARCH_FIELDS.includes(field);\r\n  };\r\n\r\n  // doesn't fully work on api side yet\r\n  // @see https://yt.skbkontur.ru/issue/PS-1401\r\n  public isAllowedToSearchThroughChildrenOfDirectParent = (\r\n    field: FiasFields,\r\n    fieldsSettings?: FiasFieldsSettings,\r\n  ): boolean => {\r\n    if (fieldsSettings) {\r\n      for (const parentField of FiasAddress.getParentFields(field)) {\r\n        if (!FiasAddress.isFieldVisible(parentField, fieldsSettings)) {\r\n          return false;\r\n        }\r\n      }\r\n    }\r\n    return FiasAddress.NOT_ONLY_DIRECT_PARENT_SEARCH_FIELDS.includes(field);\r\n  };\r\n\r\n  public hasOnlyIndirectParent = (field?: FiasFields): boolean => {\r\n    if (field) {\r\n      const parents = FiasAddress.getParentFields(field);\r\n      if (parents.length > 1) {\r\n        const directParent = this.fields[parents.pop() as FiasFields];\r\n        return !directParent && parents.some(parent => Boolean(this.fields[parent]));\r\n      }\r\n    }\r\n    return false;\r\n  };\r\n\r\n  public getClosestParentFiasId = (field: FiasFields): FiasId | undefined => {\r\n    if (!this.isEmpty) {\r\n      const parents = FiasAddress.getParentFields(field)\r\n        .slice()\r\n        .reverse();\r\n      for (const parentField of parents) {\r\n        const parent = this.fields[parentField];\r\n        if (parent) {\r\n          return parent.fiasId;\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  public getFiasId = (): FiasId => {\r\n    if (!this.isEmpty) {\r\n      const fields = FiasAddress.MAIN_FIELDS.slice().reverse();\r\n      for (const field of fields) {\r\n        const element = this.fields[field];\r\n        if (element && element.fiasId) {\r\n          return element.fiasId;\r\n        }\r\n      }\r\n    }\r\n    return '';\r\n  };\r\n\r\n  public getParent = (field: FiasFields): FiasAddressElement | undefined => {\r\n    if (this.fields[field]) {\r\n      const parents = FiasAddress.getParentFields(field).filter(f => Boolean(this.fields[f]));\r\n      const closest = parents.pop();\r\n      if (closest) {\r\n        return this.fields[closest];\r\n      }\r\n    }\r\n  };\r\n\r\n  public verifyConsistency = (): FiasVerifyResponse => {\r\n    const verifiedFields: FiasAddressFields = { ...this.fields };\r\n\r\n    for (const field of FiasAddress.MAIN_FIELDS) {\r\n      const element = this.fields[field];\r\n      if (element) {\r\n        if (element.data) {\r\n          const expectedParentFiasId = element.data.parentFiasId;\r\n          const parent = this.getParent(field);\r\n          if (!parent || parent.fiasId === expectedParentFiasId) {\r\n            verifiedFields[field] = element;\r\n            continue;\r\n          }\r\n        }\r\n        return {\r\n          address: FiasAddress.fieldsToResponse(verifiedFields),\r\n          isValid: false,\r\n          invalidLevel: field,\r\n        };\r\n      }\r\n    }\r\n    return {\r\n      address: FiasAddress.fieldsToResponse(verifiedFields),\r\n      isValid: true,\r\n    };\r\n  };\r\n\r\n  public getFiasPostalCode = (): string => {\r\n    if (!this.isEmpty) {\r\n      const fields = FiasAddress.MAIN_FIELDS.slice().reverse();\r\n      for (const field of fields) {\r\n        const element = this.fields[field];\r\n        if (element && element.data && element.data.postalCode) {\r\n          return element.data.postalCode;\r\n        }\r\n      }\r\n    }\r\n    return '';\r\n  };\r\n\r\n  public getAddressValue = (): FiasAddressValue => {\r\n    const fields = Object.keys(this.fields) as FiasFields[];\r\n    return fields.reduce((value, field) => {\r\n      const element = this.fields[field];\r\n      if (!element) {\r\n        return value;\r\n      }\r\n      const { name, fiasData } = element;\r\n      return {\r\n        ...value,\r\n        [field]: {\r\n          name,\r\n          ...(fiasData ? { data: fiasData } : {}),\r\n        },\r\n      };\r\n    }, {});\r\n  };\r\n\r\n  // TODO: get fields usage from fieldsSettings\r\n  public getValue = (withPostalCode = false): FiasValue => {\r\n    const { country, foreignAddress } = this;\r\n    return {\r\n      address: this.getAddressValue(),\r\n      addressString: this.getFullText(withPostalCode),\r\n      addressErrors: this.getAddressErrors(),\r\n      fiasId: this.getFiasId(),\r\n      postalCode: this.postalCode,\r\n      ...(country ? { country } : {}),\r\n      ...(this.isForeign ? { foreignAddress } : {}),\r\n    };\r\n  };\r\n\r\n  public convertForVerification = () => {\r\n    return FiasAddress.VERIFIABLE_FIELDS.reduce((value, field) => {\r\n      const element = this.fields[field];\r\n      if (!element) {\r\n        return value;\r\n      }\r\n      return {\r\n        ...value,\r\n        [field]: {\r\n          ...element.verifiableData,\r\n        },\r\n      };\r\n    }, {});\r\n  };\r\n\r\n  public getDiffFields = (address: FiasAddress, fieldsSettings?: FiasFieldsSettings): FiasAddressFields => {\r\n    const fields = fieldsSettings\r\n      ? FiasAddress.filterVisibleFields(address.fields, fieldsSettings)\r\n      : { ...address.fields };\r\n    for (const field of FiasAddress.MAIN_FIELDS) {\r\n      const element = fields[field];\r\n      if (element) {\r\n        if (element.isEqualTo(this.fields[field])) {\r\n          delete fields[field];\r\n        } else {\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    return fields;\r\n  };\r\n}\r\n"]}